name: Web App CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  web:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install deps
        run: pnpm install

      - name: Build web
        run: pnpm -C apps/web build

      - name: Start web and verify Deploy Mark
        shell: bash
        run: |
          set -euo pipefail

          PORT=3000
          URL="http://localhost:${PORT}"
          PID_FILE="/tmp/next.pid"
          LOG_FILE="/tmp/next.log"

          cleanup() {
            echo "→ Cleaning up"
            if [[ -f "$PID_FILE" ]]; then
              PID="$(cat "$PID_FILE" || true)"
              if [[ -n "${PID:-}" ]]; then
                echo "→ Stopping web server (pid ${PID})"
                kill "$PID" >/dev/null 2>&1 || true
              fi
            fi

            if [[ -f "$LOG_FILE" ]]; then
              echo "---- next log (last 200 lines) ----"
              tail -n 200 "$LOG_FILE" || true
            fi
          }
          trap cleanup EXIT

          echo "→ Starting Next.js on :${PORT}"
          (cd apps/web && pnpm start -p "$PORT" >"$LOG_FILE" 2>&1 & echo $! > "$PID_FILE")

          echo "→ Waiting for ${URL}"
          for i in {1..60}; do
            if curl -fsS "$URL" >/dev/null; then
              echo "✓ Server is up"
              break
            fi
            sleep 1
          done

          if ! curl -fsS "$URL" >/dev/null; then
            echo "✗ Server did not start in time"
            exit 1
          fi

          echo "→ Verifying deploy mark"
          ./scripts/verify-deploy-mark.sh

          echo "✓ CI web check passed"